name: Test Database Migrations

on:
  push:
    paths:
      - "**.py"
  pull_request:
    paths:
      - "**.py"

jobs:
  test-databases:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:latest
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testdb
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -hlocalhost -uroot -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      mariadb:
        image: mariadb:10.6
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testdb
          MYSQL_USER: testuser
          MYSQL_PASSWORD: testpassword
        ports:
          - 3307:3306
        options: >-
          --health-cmd "mysqladmin ping -h localhost -u testuser --password=testpassword"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    strategy:
      matrix:
        db: [sqlite, mysql, mariadb]
        include:
          - db: sqlite
            url: sqlite:///./test.db

          - db: mysql
            url: mysql+pymysql://root:root@localhost:3306/testdb

          - db: mariadb
            url: mysql+pymysql://testuser:testpassword@localhost:3307/testdb

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Set DATABASE_URL
        run: |
          echo "TEST_FROM=github" >> $GITHUB_ENV
          echo "SQLALCHEMY_DATABASE_URL=${{ matrix.url }}" >> $GITHUB_ENV

      - name: Upgrade pip, setuptools and wheel
        run: |
          python -m pip install --upgrade pip setuptools wheel

      - name: Install project dependencies
        run: |
          pip install -e .
          pip install pymysql
          
      - name: Install test dependencies
        run: |
          # Install test dependencies directly (dependency groups may not be supported in all pip versions)
          echo "Installing test dependencies..."
          pip install "pytest>=8.3.5" "pytest-asyncio>=0.26.0" "pytest-watch>=4.2.0" "httpx>=0.27.2" "ruff>=0.11.6"
          
      - name: Verify pytest is installed
        run: |
          python -m pytest --version

      - name: Verify database connection
        run: |
          python -c "
          import os
          from sqlalchemy import create_engine, text
          url = os.environ.get('SQLALCHEMY_DATABASE_URL', '')
          if 'sqlite' not in url:
              engine = create_engine(url)
              with engine.connect() as conn:
                  result = conn.execute(text('SELECT 1'))
                  print(f'Database connection successful: {url.split(\"@\")[-1] if \"@\" in url else url}')
          else:
              print(f'Using SQLite: {url}')
          "

      - name: Check migration status before upgrade
        run: |
          alembic current || echo "No migrations applied yet"

      - name: Run Alembic Migrations
        run: |
          echo "Running migrations for: ${{ matrix.db }}"
          alembic upgrade head
          echo "Migrations completed successfully"

      - name: Verify migration status after upgrade
        run: |
          echo "Current migration revision:"
          alembic current

      - name: Verify database schema
        run: |
          python -c "
          import os
          from sqlalchemy import create_engine, inspect, text
          url = os.environ.get('SQLALCHEMY_DATABASE_URL', '')
          engine = create_engine(url)
          inspector = inspect(engine)
          tables = inspector.get_table_names()
          print(f'Found {len(tables)} tables: {sorted(tables)}')
          
          # Verify key tables exist
          key_tables = ['users', 'admins', 'nodes', 'services']
          for table in key_tables:
              if table in tables:
                  print(f'✓ Table {table} exists')
                  cols = [col['name'] for col in inspector.get_columns(table)]
                  print(f'  Columns: {len(cols)} columns')
              else:
                  print(f'✗ Table {table} missing')
          "

      - name: Run Tests
        run: python -m pytest
