syntax = "proto3";

package rebecca.app.router;

import "rebecca/common/serial/typed_message.proto";
import "rebecca/common/net/port.proto";
import "rebecca/common/net/network.proto";

message Domain {
  enum Type {
    Plain = 0;
    Regex = 1;
    Domain = 2;
    Full = 3;
  }

  Type type = 1;
  string value = 2;

  message Attribute {
    string key = 1;

    oneof typed_value {
      bool bool_value = 2;
      int64 int_value = 3;
    }
  }

  repeated Attribute attribute = 3;
}

message CIDR {
  bytes ip = 1;
  uint32 prefix = 2;
}

message GeoIP {
  string country_code = 1;
  repeated CIDR cidr = 2;
  bool reverse_match = 3;
}

message GeoIPList {
  repeated GeoIP entry = 1;
}

message GeoSite {
  string country_code = 1;
  repeated Domain domain = 2;
}

message GeoSiteList {
  repeated GeoSite entry = 1;
}

message RoutingRule {
  oneof target_tag {
    string tag = 1;
    string balancing_tag = 12;
  }
  string rule_tag = 18;

  repeated Domain domain = 2;
  repeated CIDR cidr = 3 [deprecated = true];
  repeated GeoIP geoip = 10;

  rebecca.common.net.PortRange port_range = 4 [deprecated = true];
  rebecca.common.net.PortList port_list = 14;

  rebecca.common.net.NetworkList network_list = 5 [deprecated = true];
  repeated rebecca.common.net.Network networks = 13;

  repeated CIDR source_cidr = 6 [deprecated = true];
  repeated GeoIP source_geoip = 11;
  rebecca.common.net.PortList source_port_list = 16;

  repeated string user_email = 7;
  repeated string inbound_tag = 8;
  repeated string protocol = 9;

  map<string, string> attributes = 15;
  string domain_matcher = 17;
}

message BalancingRule {
  string tag = 1;
  repeated string outbound_selector = 2;
  string strategy = 3;
  rebecca.common.serial.TypedMessage strategy_settings = 4;
  string fallback_tag = 5;
}

message StrategyWeight {
  bool regexp = 1;
  string match = 2;
  float value = 3;
}

message StrategyLeastLoadConfig {
  repeated StrategyWeight costs = 2;
  repeated int64 baselines = 3;
  int32 expected = 4;
  int64 maxRTT = 5;
  float tolerance = 6;
}

message Config {
  enum DomainStrategy {
    AsIs = 0;
    UseIp = 1;
    IpIfNonMatch = 2;
    IpOnDemand = 3;
  }

  DomainStrategy domain_strategy = 1;
  repeated RoutingRule rule = 2;
  repeated BalancingRule balancing_rule = 3;
}

